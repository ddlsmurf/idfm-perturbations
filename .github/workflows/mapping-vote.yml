name: Check Mapping Vote
run-name: "Check mapping vote (issue #1)"

on:
  schedule:
    - cron: '30 */8 * * *'
  workflow_dispatch:

permissions:
  issues: write
  actions: write

jobs:
  check-vote:
    runs-on: ubuntu-latest
    steps:
      - name: Check reactions and manage comments
        id: vote
        uses: actions/github-script@v7
        with:
          script: |
            const ISSUE = 1;
            const THRESHOLD = 10;
            const BOT_LOGIN = 'github-actions[bot]';
            const COMMENT_BODY = `ðŸ‘ **${THRESHOLD}** reactions here will trigger a mapping update (checked every 8h).\n${THRESHOLD} rÃ©actions ici dÃ©clencheront une mise Ã  jour (vÃ©rifiÃ© toutes les 8h).`;

            function makeCommentBody() {
              return COMMENT_BODY;
            }

            function makeIssueBody(commentUrl) {
              return [
                `React with ðŸ‘ to [the latest comment](${commentUrl}) to request a mapping update.`,
                `**${THRESHOLD}** reactions will trigger a regeneration (checked every 6 hours).`,
                '',
                '---',
                '',
                `RÃ©agissez avec ðŸ‘ sur [le dernier commentaire](${commentUrl}) pour demander une mise Ã  jour.`,
                `**${THRESHOLD}** rÃ©actions dÃ©clencheront une rÃ©gÃ©nÃ©ration (vÃ©rification toutes les 6 heures).`,
              ].join('\n');
            }

            async function updateIssueIfNeeded(commentUrl) {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ISSUE,
              });
              const wantBody = makeIssueBody(commentUrl);
              if (issue.body === wantBody) return;
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ISSUE,
                body: wantBody,
              });
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ISSUE,
            });

            const voteComment = comments
              .filter(c => c.user.login === BOT_LOGIN && c.body === COMMENT_BODY)
              .pop();

            if (!voteComment) {
              const { data: created } = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ISSUE,
                body: makeCommentBody(),
              });
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: created.id,
                content: '+1',
              });
              await updateIssueIfNeeded(created.html_url);
              core.notice(`Created initial vote comment #${created.id}`);
              core.summary
                .addHeading('Mapping Vote', 2)
                .addRaw('No vote comment found â€” created initial comment.')
                .write();
              return;
            }

            const { data: reactions } = await github.rest.reactions.listForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: voteComment.id,
            });
            const ADMIN = 'ddlsmurf';
            const adminHeart = reactions.some(r => r.content === 'heart' && r.user.login === ADMIN);
            const thumbsUp = adminHeart ? THRESHOLD : reactions.filter(r => r.content === '+1').length;
            const voters = adminHeart
              ? [`${ADMIN} â¤ï¸`]
              : reactions.filter(r => r.content === '+1').map(r => r.user.login);

            if (thumbsUp < THRESHOLD) {
              core.notice(`${thumbsUp}/${THRESHOLD} ðŸ‘ â€” not enough to trigger`);
              core.summary
                .addHeading('Mapping Vote', 2)
                .addTable([
                  [{data: 'Metric', header: true}, {data: 'Value', header: true}],
                  ['Reactions', `${thumbsUp} / ${THRESHOLD}`],
                  ['Status', 'Waiting for more votes'],
                  ['Comment', `<a href="${voteComment.html_url}">#${voteComment.id}</a>`],
                ])
                .write();
              return;
            }

            // Threshold reached â€” strike out old vote comments
            const oldVoteComments = comments
              .filter(c => c.user.login === BOT_LOGIN && c.body === COMMENT_BODY);
            for (const old of oldVoteComments) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: old.id,
                body: `~~${old.body.replace(/\n/g, '~~\n~~')}~~\n\n_Triggered ${new Date().toISOString()}_`,
              });
            }

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'mapping.yml',
              ref: 'main',
            });

            const { data: newComment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ISSUE,
              body: makeCommentBody(),
            });
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: newComment.id,
              content: '+1',
            });

            await updateIssueIfNeeded(newComment.html_url);
            core.notice(`Triggered mapping update (${thumbsUp} ðŸ‘ from ${voters.join(', ')})`);
            core.summary
              .addHeading('Mapping Vote â€” Triggered! ðŸŽ‰', 2)
              .addTable([
                [{data: 'Metric', header: true}, {data: 'Value', header: true}],
                ['Reactions', `${thumbsUp} / ${THRESHOLD}`],
                ['Voters', voters.map(v => `@${v}`).join(', ')],
                ['Status', 'Mapping workflow dispatched'],
              ])
              .write();
